<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>💬 Chat Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/inline_styles.css">
</head>
<body class="page-load">
    <div class="container py-4 fade-in" style="max-width: 100%; min-height: max-content;">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <img class="logo" src="img/logo.png" alt="Alexa360 Logo">
            <h1 class="text-center mb-0" data-translate="pageTitle">💬 Chat Conversation Search</h1>
            <div class="d-flex align-items-center gap-3">
                <!-- Language Selection -->
                <div class="language-selector">
                    <label for="languageSelect" class="sr-only">Select language</label>
                    <select class="form-select form-select-sm" id="languageSelect" style="width: auto; min-width: 120px;" 
                            aria-label="Select your preferred language" role="combobox">
                        <option value="en">🇺🇸 English</option>
                        <option value="ar">🇸🇦 العربية</option>
                        <option value="fr">🇫🇷 Français</option>
                        <option value="es">🇪🇸 Español</option>
                        <option value="de">🇩🇪 Deutsch</option>
                        <option value="it">🇮🇹 Italiano</option>
                        <option value="pt">🇵🇹 Português</option>
                        <option value="ru">🇷🇺 Русский</option>
                        <option value="zh">🇨🇳 中文</option>
                        <option value="ja">🇯🇵 日本語</option>
                        <option value="ko">🇰🇷 한국어</option>
                    </select>
                </div>
                
                <!-- API Key Status -->
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-secondary" id="apiKeyStatus" data-translate="apiKeySet">API Key Set</span>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="changeApiKey" data-translate="changeApiKey">Change</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="removeApiKeyBtn" style="display: none;" data-translate="removeApiKey">Remove</button>
                </div>
            </div>
        </header>

        <!-- API Key Input Section (shown when no API key is set) -->
        <section class="api-key-section mb-4" id="apiKeySection" style="display: none;">
            <div class="card shadow-sm border-warning">
                <div class="card-header bg-warning text-dark">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>
                        <span data-translate="apiKeyRequired">API Key Required</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="apiKeyInput" class="form-label fw-bold" data-translate="enterApiKey">Enter Your API Key</label>
                            <div class="input-group">
                                <input type="password" id="apiKeyInput" class="form-control" 
                                       data-translate-placeholder="pasteApiKey" placeholder="Paste your API key here...">
                                <button class="btn btn-outline-secondary" type="button" id="toggleApiKeyVisibility" 
                                        title="Toggle visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-shield-alt me-1"></i>
                                <span data-translate="apiKeySecurityNote">Your API key is stored locally and never sent to our servers</span>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" id="saveApiKeyBtn">
                                <i class="fas fa-save me-2"></i>
                                <span data-translate="saveApiKey">Save API Key</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Search Filters Section -->
        <section class="search-filters mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0" data-translate="searchFilters">🔍 Search Filters</h3>
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="userNS" class="form-label fw-bold" data-translate="userNS">🆔 User NS *</label>
                                <input type="text" class="form-control" id="userNS" name="userNS" 
                                       data-translate-placeholder="userNSPlaceholder" placeholder="Enter User NS (e.g., f180949u355983953)" required>
                            </div>
                            <div class="col-md-6">
                                <label for="limit" class="form-label fw-bold" data-translate="resultsPerPage">📄 Results per Page</label>
                                <select class="form-select" id="limit" name="limit">
                                    <option value="10">10</option>
                                    <option value="20" selected>20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="startDate" class="form-label fw-bold" data-translate="startDate">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="startDate">
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label fw-bold" data-translate="endDate">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="endDate">
                            </div>
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeBot" name="includeBot" checked>
                                    <label class="form-check-label" for="includeBot" data-translate="includeBot">🤖 Include Bot Messages</label>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary btn-search" data-translate="searchConversations">🔍 Search Conversations</button>
                                    <button type="button" class="btn btn-outline-secondary" id="clearBtn" data-translate="clearSearch">🗑️ Clear Search</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Error Alert Section -->
        <section class="error-section mb-4" id="errorSection" style="display: none;">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong data-translate="error">Error:</strong> <span data-translate="provideUserNS">Please provide User NS to search.</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </section>

        <!-- Chat Messages Section -->
        <section class="chat-section">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="card-title mb-0" data-translate="chatMessages">💬 Chat Messages</h4>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container" id="chatContainer">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p data-translate="noMessagesToDisplay">No messages to display. Please search for conversations.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pagination Section -->
        <section class="pagination-section mt-4" id="paginationSection" style="display: none;">
            <nav aria-label="Chat pagination">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be dynamically generated here -->
                </ul>
            </nav>
        </section>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- API Key Management Script -->
    <script>
        // Initialize API key management
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api_key');
            const demoMode = urlParams.get('demo') === 'true';
            
            // Check if we have an API key from URL or localStorage
            let currentApiKey = apiKey || localStorage.getItem('alexa360_api_key');
            
            // Store API key if provided via URL and clean up the URL
            if (apiKey) {
                localStorage.setItem('alexa360_api_key', apiKey);
                
                // Remove API key from URL for security
                urlParams.delete('api_key');
                const cleanUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                
                // Replace the current URL without the API key
                window.history.replaceState({}, document.title, cleanUrl);
            }
            
            // Update API key status display
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            const removeApiKeyBtn = document.getElementById('removeApiKeyBtn');
            
            if (demoMode) {
                apiKeyStatus.textContent = 'Demo Mode';
                apiKeyStatus.parentElement.parentElement.classList.add('text-warning');
                removeApiKeyBtn.style.display = 'none';
            } else if (currentApiKey) {
                apiKeyStatus.textContent = 'API Key Set';
                apiKeyStatus.parentElement.parentElement.classList.add('text-success');
                removeApiKeyBtn.style.display = 'block';
            }
            
            // Handle change API key button
            document.getElementById('changeApiKey').addEventListener('click', function() {
                localStorage.removeItem('alexa360_api_key');
                location.reload();
            });
            
            // Handle remove API key button
            removeApiKeyBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to remove the stored API key? This will clear it from your browser.')) {
                    localStorage.removeItem('alexa360_api_key');
                    location.reload();
                }
            });
            
            // Make API key available globally
            window.currentApiKey = currentApiKey;
            window.demoMode = demoMode;
        });
    </script>
    
    <script src="js/inline_scripts_vercel.js"></script>
    
</body>
</html>
